<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Integrazione con business.coresuite.it</title>
<style>
  body {
    font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
    color: #1f2933;
    margin: 24px 40px;
    line-height: 1.55;
    font-size: 12pt;
  }
  h1, h2, h3 {
    color: #0b3d91;
    margin-top: 28px;
  }
  h1 { font-size: 24pt; }
  h2 { font-size: 18pt; }
  h3 { font-size: 14pt; }
  code { font-family: 'Fira Code', 'Consolas', 'Courier New', monospace; background: #f3f4f6; padding: 2px 4px; border-radius: 4px; }
  pre { background: #f3f4f6; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 10pt; }
  ul, ol { margin-left: 22px; }
  table { border-collapse: collapse; width: 100%; margin: 16px 0; }
  th, td { border: 1px solid #cbd5e1; padding: 8px 10px; text-align: left; }
  th { background: #0b3d91; color: #fff; }
  hr { border: none; border-top: 1px solid #d1d5db; margin: 32px 0; }
  .callout {
    border-left: 4px solid #f59e0b;
    background: #fffbea;
    padding: 12px 16px;
    border-radius: 4px;
    margin: 18px 0;
  }
  .checklist {
    list-style: none;
    padding-left: 0;
  }
  .checklist li::before {
    content: '\2713';
    color: #059669;
    margin-right: 8px;
  }
</style>
</head>
<body>
<h1>Integrazione con business.coresuite.it</h1>
<p>Questa guida descrive come collegare <strong>Coresuite Express</strong> all'ERP <strong>business.coresuite.it</strong> utilizzando il connettore introdotto in <code>IntegrationService</code>. Segui i passaggi nell'ordine indicato: prima prepara l'integrazione lato ERP, poi completa la configurazione nell'app Express e infine verifica il flusso dati.</p>
<hr>
<h2>1. Prerequisiti</h2>
<ul>
  <li>Account <strong>amministratore</strong> su business.coresuite.it.</li>
  <li>Ambiente Coresuite Express aggiornato al codice che include <code>IntegrationService</code> (branch <code>main</code>, commit &gt; integrazione esterna).</li>
  <li>Accesso al server dove gira Express per modificare il file <code>.env</code> e leggere i log.</li>
  <li>Database aggiornato con le ultime migrazioni.</li>
</ul>
<hr>
<h2>2. Configurazione su business.coresuite.it</h2>
<ol>
  <li>Accedi al portale ERP con credenziali amministrative.</li>
  <li>Vai in <strong>Impostazioni → Integrazioni/API</strong> (il nome può variare a seconda della versione).</li>
  <li>Crea una <strong>nuova applicazione</strong> denominata, ad esempio, <code>coresuite-express</code>.</li>
  <li>Imposta i permessi minimi necessari:
    <ul>
      <li>Lettura/Scrittura su anagrafiche clienti.</li>
      <li>Lettura/Scrittura su catalogo prodotti e stock.</li>
      <li>Creazione ordini/vendite.</li>
      <li>Facoltativo: permessi per scrivere log o note interne.</li>
    </ul>
  </li>
  <li>Salva e recupera i valori forniti dalla piattaforma:
    <ul>
      <li><strong>API Key</strong> (obbligatoria) → da copiare in <code>CORESUITE_API_KEY</code>.</li>
      <li><strong>Webhook secret / firma</strong> (se disponibile) → da copiare in <code>CORESUITE_WEBHOOK_SECRET</code>.</li>
      <li><strong>Tenant / Organization ID</strong> (se previsto) → da copiare in <code>CORESUITE_TENANT</code>.</li>
    </ul>
  </li>
  <li>Se la console ERP richiede URL di callback per ricevere webhook, inserisci: <code>https://&lt;dominio-express&gt;/public/index.php?page=notifications_stream</code> oppure un endpoint custom se ne prevedi uno dedicato.</li>
  <li>Prendi nota eventuale dei <strong>rate limit</strong> o delle finestre di autenticazione (alcuni ambienti rigenerano le chiavi periodicamente).</li>
</ol>
<div class="callout"><strong>Suggerimento:</strong> crea un utente di servizio dedicato all'integrazione così da poter disattivare/ruotare credenziali senza impattare gli utenti umani.</div>
<hr>
<h2>3. Configurazione in Coresuite Express</h2>
<ol>
  <li>Apri il file <code>.env</code> e popola le variabili della sezione integrazioni:
    <pre><code>CORESUITE_BASE_URL=https://business.coresuite.it
CORESUITE_API_KEY=la_tua_api_key_generata
CORESUITE_TENANT=tenant_o_organizzazione
CORESUITE_WEBHOOK_SECRET=secret_opzionale
CORESUITE_ENDPOINTS=
</code></pre>
  </li>
  <li>Lascia <code>CORESUITE_ENDPOINTS</code> vuoto per usare i percorsi di default del connettore oppure inserisci una mappa JSON per personalizzarli, ad esempio:
    <pre><code>CORESUITE_ENDPOINTS={"customers":"/api/customers","products":"/api/products"}
</code></pre>
  </li>
  <li>Salva il file, quindi <strong>riavvia PHP-FPM / il web server</strong> per caricare le nuove variabili (oppure svuota l'OPcache se attivo).</li>
  <li>Verifica che <code>storage/logs/integrations.log</code> sia scrivibile dall'utente del web server.</li>
</ol>
<hr>
<h2>4. Endpoint utilizzati da Coresuite Express</h2>
<table>
  <thead>
    <tr>
      <th>Operazione</th>
      <th>Metodo</th>
      <th>Endpoint predefinito</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Upsert cliente</td>
      <td>PUT</td>
      <td><code>/api/integrations/customers</code></td>
      <td>Payload con <code>external_id</code>, anagrafica e contatti del cliente.</td>
    </tr>
    <tr>
      <td>Cancellazione cliente</td>
      <td>DELETE</td>
      <td><code>/api/integrations/customers/{id}</code></td>
      <td><code>{id}</code> è l'<code>external_id</code> (es. <code>customer-123</code>).</td>
    </tr>
    <tr>
      <td>Upsert prodotto</td>
      <td>PUT</td>
      <td><code>/api/integrations/products</code></td>
      <td>Include prezzo, stock, aliquote IVA e SKU.</td>
    </tr>
    <tr>
      <td>Invio vendita</td>
      <td>POST</td>
      <td><code>/api/integrations/sales</code></td>
      <td>Invio scontrino completo con righe e totali.</td>
    </tr>
    <tr>
      <td>Movimenti magazzino</td>
      <td>POST</td>
      <td><code>/api/integrations/inventory</code></td>
      <td>Utilizzato per allineamenti stock manuali.</td>
    </tr>
  </tbody>
</table>
<p>Puoi sovrascrivere ciascun percorso via <code>CORESUITE_ENDPOINTS</code> passando un oggetto JSON con le chiavi <code>customers</code>, <code>customer_delete</code>, <code>products</code>, <code>sales</code>, <code>inventory</code>.</p>
<hr>
<h2>5. Struttura dei payload</h2>
<h3>Cliente</h3>
<pre><code>{
  "external_id": "customer-42",
  "full_name": "Mario Rossi",
  "email": "mario.rossi@example.com",
  "phone": "+39061234567",
  "tax_code": "RSSMRA80A01H501Z",
  "note": "Cliente business",
  "synced_at": "2025-11-01T10:24:15+01:00"
}
</code></pre>
<h3>Prodotto</h3>
<pre><code>{
  "external_id": "product-15",
  "name": "iPhone 16 Pro",
  "sku": "IP16PRO-256-SILVER",
  "imei": null,
  "category": "Smartphone",
  "price": 1499.99,
  "stock_quantity": 8,
  "tax_rate": 22.0,
  "vat_code": "IVA22",
  "is_active": true,
  "synced_at": "2025-11-01T10:24:15+01:00"
}
</code></pre>
<h3>Vendita</h3>
<pre><code>{
  "external_id": "sale-104",
  "customer_external_id": "customer-42",
  "customer_name": "Mario Rossi",
  "total": 1599.99,
  "total_paid": 1599.99,
  "balance_due": 0.0,
  "payment_status": "Paid",
  "due_date": null,
  "vat_rate": 22.0,
  "vat_amount": 288.52,
  "discount": 50.0,
  "items": [
    {
      "description": "iPhone 16 Pro 256GB Silver",
      "quantity": 1,
      "unit_price": 1499.99,
      "tax_rate": 22.0,
      "tax_amount": 270.90,
      "product_external_id": "product-15",
      "iccid_code": null
    }
  ],
  "synced_at": "2025-11-01T10:32:41+01:00"
}
</code></pre>
<p>Assicurati che il team ERP sappia interpretare <code>external_id</code>: la parte numerica corrisponde all'ID locale (clienti, prodotti, vendite) in Express.</p>
<hr>
<h2>6. Flusso di sincronizzazione</h2>
<ol>
  <li><strong>Clienti</strong>: ogni creazione/aggiornamento/eliminazione cliente in Express genera una chiamata verso l'ERP.</li>
  <li><strong>Prodotti</strong>: <code>ProductService</code> invia sync dopo creazioni, aggiornamenti, variazioni fiscali.</li>
  <li><strong>Vendite</strong>: al salvataggio della vendita viene inviato il documento; in caso di cancellazioni o resi viene reinviata la versione aggiornata.</li>
  <li><strong>Magazzino</strong>: movimenti espliciti (es. aggiustamenti stock) generano payload <code>inventory</code>.</li>
</ol>
<p>Se l'ERP espone webhook di ritorno, valuta di implementarli per mantenere la sincronizzazione bidirezionale (non coperto da questa guida).</p>
<hr>
<h2>7. Verifica e troubleshooting</h2>
<ol>
  <li>Abilita il log in <code>storage/logs/integrations.log</code>. Dopo ogni operazione dovresti vedere righe tipo:
    <pre><code>2025-11-01T10:25:01+01:00 | PUT https://business.coresuite.it/api/integrations/customers | 200
</code></pre>
  </li>
  <li>In caso di errore, la riga includerà <code>error=...</code>. Condividi il messaggio con il team ERP per identificare problemi di autenticazione/percorso.</li>
  <li>Se le chiamate non arrivano, controlla che:
    <ul>
      <li>le variabili <code>.env</code> siano corrette e applicate;</li>
      <li>il server possa raggiungere l'URL ERP (firewall, DNS);</li>
      <li>non ci siano errori PHP (consulta <code>storage/logs</code> e il web server).</li>
    </ul>
  </li>
</ol>
<hr>
<h2>8. Checklist finale</h2>
<ul class="checklist">
  <li>Credenziali generate e salvate in modo sicuro.</li>
  <li>Variabili <code>.env</code> popolate e servizio riavviato.</li>
  <li>Primo cliente sincronizzato con esito <code>200 OK</code>.</li>
  <li>Verifica manuale nel catalogo ERP della vendita di prova.</li>
  <li>Piano di rotazione credenziali e gestione degli errori condiviso con il team.</li>
</ul>
<p>Quando tutti i passi sono completi puoi considerare l'integrazione in produzione. Per domande o problemi aperti, raccogli il contenuto del log <code>integrations.log</code> e la risposta HTTP dell'ERP: ci serviranno per diagnosticare insieme eventuali errori.</p>
</body>
</html>
